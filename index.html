<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ESP32 LED 제어</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 100px;
    }
    input[type="range"] {
      width: 300px;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>ESP32 LED 깜빡임 주기 조절</h2>
  <input type="range" id="slider" min="100" max="2000" value="500" step="100">
  <div>주기: <span id="value">500</span> ms</div>
  <div id="status">MQTT 연결 상태: <span id="mqtt-status">연결 시도 중...</span></div>

  <!-- MQTT.js CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const slider = document.getElementById("slider");
    const value = document.getElementById("value");
    const statusEl = document.getElementById("mqtt-status");

    const topic = "esp32c3/led/blink";
    const client = mqtt.connect("ws://mqtt.jjlabs.kr:9001");

    client.on("connect", () => {
      console.log("MQTT 연결 성공");
      statusEl.textContent = "연결됨";

      // ✅ 슬라이더 값 동기화를 위해 현재 토픽 구독
      client.subscribe(topic);
    });

    client.on("message", (receivedTopic, payload) => {
      if (receivedTopic === topic) {
        const currentValue = payload.toString();
        slider.value = currentValue;
        value.textContent = currentValue;
        console.log("초기 MQTT 값 수신:", currentValue);
      }
    });

    client.on("error", (err) => {
      console.error("MQTT 연결 실패", err);
      statusEl.textContent = "연결 실패";
    });

    slider.oninput = () => {
      const interval = slider.value;
      value.textContent = interval;
      client.publish(topic, interval, { retain: true }, (err) => {
        if (err) {
          console.error("MQTT 전송 실패:", err);
          statusEl.textContent = "전송 실패";
        } else {
          console.log("MQTT 전송 성공:", interval);
          statusEl.textContent = `전송됨: ${interval} ms`;
        }
      });
    };
  </script>
</body>
</html>
